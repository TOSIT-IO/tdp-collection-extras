---
- name: Ensure hadoop group exists
  include_role:
    name: tosit.tdp.utils.group
  vars:
    group: "{{ airflow_group }}"

- name: Ensure airflow user exists
  include_role:
    name: tosit.tdp.utils.user
  vars:
    user: "{{ airflow_user }}"
    group: "{{ airflow_group }}"

- name: Ensures {{ airflow_root_dir }}/airflow-{{ airflow_version }} exists
  file:
    path: "{{ airflow_root_dir }}/airflow-{{ airflow_version }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Create symbolic link to Airflow installation
  file:
    src: "{{ airflow_root_dir }}/airflow-{{ airflow_version }}"
    dest: "{{ airflow_install_dir }}"
    state: link

- name: Template Constraint file
  template:
    src: "{{ airflow_constraints_file }}.j2"
    dest: "/tmp/{{ airflow_constraints_file }}"

- name: Install Required packages
  yum:
    pkg: "{{ airflow_required_packages }}"
    state: present
  when: airflow_required_packages is defined

- name: Install virtualenv in {{ airflow_python }}
  become: true
  shell: "{{ airflow_python }} -m pip install virtualenv"

- name: Check if exists virtualenv
  stat:
    path: "{{ airflow_install_dir }}/bin"
  register: virtualenv

- name: Create a virtualenv
  shell: "virtualenv --system-site-packages -p {{ airflow_python }} {{ airflow_install_dir }}"
  when: not virtualenv.stat.exists
  environment:
    PATH: "$PATH:/usr/local/bin"

- name: upgrade virtualenv pip
  pip:
    name: pip
    extra_args: --upgrade
    virtualenv: "{{ airflow_install_dir }}"
    virtualenv_python: "{{ airflow_python }}"

- name: Install Python dependencies
  pip:
    name: "{{ airflow_required_python_packages }}"
    virtualenv: "{{ airflow_install_dir }}"
    virtualenv_python: "{{ airflow_python }}"
    extra_args: --constraint /tmp/{{ airflow_constraints_file }}
  when: airflow_required_python_packages is defined

- name: Pip install airflow {{ airflow_version }}
  pip:
    name: "apache-airflow=={{ airflow_version }}"
    virtualenv: "{{ airflow_install_dir }}"
    virtualenv_python: "{{ airflow_python }}"
    extra_args: --constraint /tmp/{{ airflow_constraints_file }}

- name: Pip install airflow extra packages
  pip:
    name: "{{ airflow_extra_packages }}"
    virtualenv: "{{ airflow_install_dir }}"
    virtualenv_python: "{{ airflow_python }}"
    extra_args: --constraint /tmp/{{ airflow_constraints_file }}
  when: airflow_extra_packages is defined

- name: Render /usr/bin/airflow command
  template:
    src: airflow-command.j2
    dest: "/usr/bin/airflow"
    owner: root
    group: root
    mode: "755"

- name: Ensures airflow configuration, log, dags and plugins directories
  become: yes
  become_user: root
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ airflow_user }}"
    group: "{{ airflow_group }}"
    mode: "{{ item.mode }}"
    recurse: yes
  with_items:
    - { path: '{{ airflow_conf_dir }}', mode: '0755' }
    - { path: '{{ airflow_certs_dir }}', mode: '0755' }
    - { path: '{{ airflow_log_dir }}', mode: '0775' }
    - { path: '{{ airflow_child_process_log_dir }}', mode: '0775' }
    - { path: '{{ airflow_dag_dir }}', mode: '0755' }
    - { path: '{{ airflow_plugins_dir }}', mode: '0755' }